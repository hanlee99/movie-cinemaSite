<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/default}">
<head>
    <title th:text="${movie != null ? movie.title + ' - 영화 상세' : '영화 상세'}">영화 상세</title>

    <th:block layout:fragment="extra-scripts">
        <script type="module" th:inline="javascript">
            import { initMovieDetail } from '/js/pages/detail.js';

            document.addEventListener('DOMContentLoaded', () => {
                const movieId = /*[[${movie?.id}]]*/ null;
                const movieTitle = /*[[${movie?.title}]]*/ null;
                if (movieId && movieTitle) {
                    initMovieDetail(movieId, movieTitle);
                }
            });
        </script>
    </th:block>
</head>
<body>
    <!-- 메인 콘텐츠 -->
    <main layout:fragment="content" class="py-8">
        <div class="max-w-4xl mx-auto px-4">
            
            <!-- 홈으로 돌아가기 버튼 -->
            <div class="mb-6">
                <a href="/" class="inline-flex items-center text-blue-600 hover:text-blue-800">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    홈으로 돌아가기
                </a>
            </div>

            <!-- 영화 상세 정보 카드 -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden" th:if="${movie != null}">
                <div class="md:flex">
                    <!-- 포스터 이미지 -->
                    <div class="md:w-1/3 p-6 flex items-center justify-center bg-gray-100">
                        <div class="aspect-[2/3] w-full max-w-xs bg-gray-200 rounded-lg overflow-hidden shadow-md">
                            <img th:if="${movie.poster != null and !movie.poster.isEmpty()}"
                                 th:src="${movie.poster}"
                                 th:alt="${movie.title}"
                                 class="w-full h-full object-cover">
                            <img th:unless="${movie.poster != null and !movie.poster.isEmpty()}"
                                 th:src="@{/images/irani12.png}"
                                 th:alt="${movie.title}"
                                 class="w-full h-full object-cover opacity-50">
                        </div>
                    </div>

                    <!-- 영화 정보 -->
                    <div class="md:w-2/3 p-6">
                        <!-- 제목 -->
                        <h1 class="text-3xl font-bold text-gray-900 mb-4" th:text="${movie.title}">영화 제목</h1>

                        <!-- 기본 정보 -->
                        <div class="space-y-2 mb-6">
                            <div class="flex items-center text-gray-600">
                                <span class="font-semibold w-20">장르</span>
                                <span th:text="${movie.genre ?: '정보 없음'}">-</span>
                            </div>
                            <div class="flex items-center text-gray-600">
                                <span class="font-semibold w-20">상영시간</span>
                                <span th:text="${movie.runtime != null ? movie.runtime + '분' : '정보 없음'}">-</span>
                            </div>
                            <div class="flex items-center text-gray-600">
                                <span class="font-semibold w-20">등급</span>
                                <span th:text="${movie.rating ?: '정보 없음'}">-</span>
                            </div>
                            <div class="flex items-center text-gray-600">
                                <span class="font-semibold w-20">개봉일</span>
                                <span th:text="${movie.repRlsDate ?: '정보 없음'}">-</span>
                            </div>
                        </div>

                        <!-- 감독 -->
                        <div class="mb-4" th:if="${movie.people != null}">
                            <h3 class="font-semibold text-gray-700 mb-2">감독</h3>
                            <div class="flex flex-wrap gap-2">
                                <span th:each="person : ${movie.people}" 
                                      th:if="${person.roleGroup == '감독'}"
                                      class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm"
                                      th:text="${person.name ?: '이름 없음'}">감독명</span>
                                <span th:if="${#lists.isEmpty(movie.people.?[roleGroup == '감독'])}" 
                                      class="text-gray-500 text-sm">정보 없음</span>
                            </div>
                        </div>

                        <!-- 배우 (최대 5명) -->
                        <div class="mb-4" th:if="${movie.people != null}">
                            <h3 class="font-semibold text-gray-700 mb-2">출연</h3>
                            <div class="flex flex-wrap gap-2">
                                <span th:each="person, iterStat : ${movie.people.?[roleGroup == '출연']}" 
                                      th:if="${iterStat.index < 5}"
                                      class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm"
                                      th:text="${person.name ?: '이름 없음'}">배우명</span>
                                <span th:if="${#lists.isEmpty(movie.people.?[roleGroup == '출연'])}" 
                                      class="text-gray-500 text-sm">정보 없음</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 줄거리 -->
                <div class="px-6 pb-6 pt-4 border-t border-gray-200">
                    <h2 class="text-xl font-bold text-gray-900 mb-3">줄거리</h2>
                    <p class="text-gray-700 leading-relaxed whitespace-pre-line"
                       th:text="${movie.plot != null and !movie.plot.isEmpty() ? movie.plot : '줄거리 정보가 없습니다.'}">
                        줄거리 내용
                    </p>
                </div>

                <!-- 관람기록 추가 버튼 (로그인한 경우만) -->
                <div class="px-6 pb-6 border-t border-gray-200" sec:authorize="isAuthenticated()">
                    <button id="addWatchHistoryBtn"
                            class="w-full py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-200 shadow-md flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        관람기록 추가
                    </button>
                </div>
            </div>
            
            <!-- 영화 정보가 없는 경우 -->
            <div th:if="${movie == null}" class="text-center py-16">
                <p class="text-gray-500">영화 정보를 찾을 수 없습니다.</p>
                <a href="/" class="inline-block mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    홈으로 돌아가기
                </a>
            </div>

        </div>

        <!-- 관람기록 추가 모달 -->
        <div id="watchHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <!-- 모달 헤더 -->
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-900">관람기록 추가</h3>
                        <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- 영화 정보 -->
                    <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600">영화</p>
                        <p class="font-semibold text-gray-900" id="modalMovieTitle"></p>
                    </div>

                    <!-- 관람기록 폼 -->
                    <form id="watchHistoryForm" class="space-y-4">
                        <!-- 관람 날짜 -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                관람 날짜 <span class="text-red-500">*</span>
                            </label>
                            <div class="flex gap-2">
                                <input type="text" id="watchedAtDisplay" readonly placeholder="날짜 선택..."
                                       class="flex-1 px-3 py-2 border-2 border-blue-500 rounded-lg bg-white !text-black placeholder-gray-500 cursor-pointer">
                                <button type="button" id="datePickerBtn"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </button>
                                <input type="date" id="watchedAt" required class="hidden">
                            </div>
                        </div>
                        <!-- 관람 날짜 -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                관람 날짜 <span class="text-red-500">*</span>
                            </label>
                            <div class="flex gap-2">
                                <input type="text" id="watchedAtDisplay" readonly placeholder="날짜 선택..."
                                       class="flex-1 px-3 py-2 border-2 border-blue-500 rounded-lg bg-white !text-black placeholder-gray-500 cursor-pointer">
                                <button type="button" id="datePickerBtn"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </button>
                                <input type="date" id="watchedAt" required class="hidden">
                            </div>
                        </div>
                        <!-- 관람 날짜 -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                관람 날짜 <span class="text-red-500">*</span>
                            </label>
                            <div class="flex gap-2">
                                <input type="text" id="watchedAtDisplay" readonly placeholder="날짜 선택..."
                                       class="flex-1 px-3 py-2 border-2 border-blue-500 rounded-lg bg-white !text-black placeholder-gray-500 cursor-pointer">
                                <button type="button" id="datePickerBtn"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </button>
                                <input type="date" id="watchedAt" required class="hidden">
                            </div>
                        </div>
                        <!-- 관람 날짜 -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                관람 날짜 <span class="text-red-500">*</span>
                            </label>
                            <div class="flex gap-2">
                                <input type="text" id="watchedAtDisplay" readonly placeholder="날짜 선택..."
                                       class="flex-1 px-3 py-2 border-2 border-blue-500 rounded-lg bg-white !text-black placeholder-gray-500 cursor-pointer">
                                <button type="button" id="datePickerBtn"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </button>
                                <input type="date" id="watchedAt" required class="hidden">
                            </div>
                        </div>
                        <!-- 관람 날짜 -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                관람 날짜 <span class="text-red-500">*</span>
                            </label>
                            <div class="flex gap-2">
                                <input type="text" id="watchedAtDisplay" readonly placeholder="날짜 선택..."
                                       class="flex-1 px-3 py-2 border-2 border-blue-500 rounded-lg bg-white !text-black placeholder-gray-500 cursor-pointer">
                                <button type="button" id="datePickerBtn"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </button>
                                <input type="date" id="watchedAt" required class="hidden">
                            </div>
                        </div>
                        <!-- 관람 날짜 -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                관람 날짜 <span class="text-red-500">*</span>
                            </label>
                            <div class="flex gap-2">
                                <input type="text" id="watchedAtDisplay" readonly placeholder="날짜 선택..."
                                       class="flex-1 px-3 py-2 border-2 border-blue-500 rounded-lg bg-white !text-black placeholder-gray-500 cursor-pointer">
                                <button type="button" id="datePickerBtn"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </button>
                                <input type="date" id="watchedAt" required class="hidden">
                            </div>
                        </div>
                        <!-- 관람 날짜 -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                관람 날짜 <span class="text-red-500">*</span>
                            </label>
                            <div class="flex gap-2">
                                <input type="text" id="watchedAtDisplay" readonly placeholder="날짜 선택..."
                                       class="flex-1 px-3 py-2 border-2 border-blue-500 rounded-lg bg-white !text-black placeholder-gray-500 cursor-pointer">
                                <button type="button" id="datePickerBtn"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </button>
                                <input type="date" id="watchedAt" required class="hidden">
                            </div>
                        </div>
                        </div>

                        <!-- 극장 검색 -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">극장 (선택)</label>
                            <input type="text" id="cinemaSearch" placeholder="극장 이름으로 검색..."
                                   class="w-full px-3 py-2 border-2 border-blue-500 rounded-lg bg-white !text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <div id="cinemaSearchResults" class="mt-2 max-h-40 overflow-y-auto hidden border-2 border-gray-300 rounded-lg bg-white shadow-sm"></div>
                            <input type="hidden" id="cinemaId">
                            <p id="selectedCinema" class="mt-2 text-sm text-gray-600"></p>
                        </div>

                        <!-- 상영 시간 -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">상영 시간 (선택)</label>
                            <input type="time" id="showTime"
                                   class="w-full px-3 py-2 border-2 border-blue-500 rounded-lg bg-white !text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <!-- 별점 -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">별점 (선택)</label>
                            <div id="ratingStars" class="flex gap-2">
                                <button type="button" class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="1">★</button>
                                <button type="button" class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="2">★</button>
                                <button type="button" class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="3">★</button>
                                <button type="button" class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="4">★</button>
                                <button type="button" class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="5">★</button>
                            </div>
                            <input type="hidden" id="rating">
                        </div>

                        <!-- 한줄평 -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">한줄평 (선택)</label>
                            <textarea id="comment" rows="3" maxlength="500" placeholder="이 영화에 대한 한줄평을 남겨주세요..."
                                      class="w-full px-3 py-2 border-2 border-blue-500 rounded-lg bg-white !text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"></textarea>
                            <p class="text-xs text-gray-500 text-right mt-1"><span id="commentCount">0</span>/500</p>
                        </div>

                        <!-- 버튼 -->
                        <div class="flex gap-3 pt-4">
                            <button type="button" id="cancelBtn"
                                    class="flex-1 py-2 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                                취소
                            </button>
                            <button type="submit"
                                    class="flex-1 py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                저장
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
</body>
</html>
