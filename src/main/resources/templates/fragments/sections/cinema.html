<section th:fragment="cinema" class="special-theater-section" style="margin: 40px 0;"
         xmlns:th="http://www.thymeleaf.org">
    <h2 style="font-size: 24px; margin-bottom: 10px; text-align: center;">ğŸ¬ íŠ¹ë³„ê´€ ê·¹ì¥ ì§€ë„</h2>
    <p style="text-align: center; color: #666; margin-bottom: 20px;">
        ì•„ì´ë§¥ìŠ¤, DOLBY CINEMA, ìˆ˜í¼í”Œë ‰ìŠ¤ ìƒì˜ ê·¹ì¥
    </p>

    <!-- ë‚´ ì£¼ë³€ ì°¾ê¸° ë²„íŠ¼ (NEW) -->
    <div style="text-align:center; margin-bottom:15px;">
        <button onclick="findNearby()"
                style="padding:12px 24px; background:#4CAF50; color:white; border:none; border-radius:5px; cursor:pointer; font-size:14px; font-weight:bold;">
            ğŸ“ ë‚´ ì£¼ë³€ íŠ¹ë³„ê´€ ì°¾ê¸°
        </button>
    </div>

    <!-- ì¹´ì¹´ì˜¤ë§µ -->
    <div id="special-cinema-map" style="width:100%; height:500px; border-radius: 8px; margin-bottom: 15px;"></div>

    <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ (NEW) -->
    <div id="nearby-result"></div>

    <!-- ë²”ë¡€ -->
    <div style="text-align: center; margin-bottom: 20px;">
        <span style="margin: 0 15px; font-size: 14px;">ğŸ”´ ì•„ì´ë§¥ìŠ¤</span>
        <span style="margin: 0 15px; font-size: 14px;">ğŸ”µ DOLBY CINEMA</span>
        <span style="margin: 0 15px; font-size: 14px;">ğŸŸ¢ ìˆ˜í¼í”Œë ‰ìŠ¤</span>
        <span style="margin: 0 15px; font-size: 14px;">â­ ë‚´ ìœ„ì¹˜</span>
    </div>

    <div style="text-align: center;">
        <a href="/cinema/list" style="display: inline-block; padding: 12px 24px;
    background: #4CAF50; color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">
            ì „ì²´ ê·¹ì¥ ë³´ê¸° â†’
        </a>
    </div>

    <script th:src="@{|https://dapi.kakao.com/v2/maps/sdk.js?appkey=${KAKAO_API_KEY}&autoload=false&libraries=services|}"></script>

    <script th:inline="javascript">

        /*<![CDATA[*/

        kakao.maps.load(() => {


        const specialCinemas = /*[[${cinemas}]]*/ [];

        console.log('íŠ¹ë³„ê´€ ê·¹ì¥ ê°œìˆ˜:', specialCinemas.length);

        // ì§€ë„ ìƒì„±
        const mapContainer = document.getElementById('special-cinema-map');
        const mapOption = {
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 8
        };
        const map = new kakao.maps.Map(mapContainer, mapOption);

        // ì§€ë„ ì»¨íŠ¸ë¡¤
        const zoomControl = new kakao.maps.ZoomControl();
        map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

        // ë²”ìœ„ ê³„ì‚°
        const bounds = new kakao.maps.LatLngBounds();

        // í˜„ì¬ ì—´ë¦° ì¸í¬ìœˆë„ìš° ì¶”ì 
        let currentInfowindow = null;

        // ë‚´ ìœ„ì¹˜ ë§ˆì»¤
        let myLocationMarker = null;

        function normalizeSpecialties(list) {
            return Array.isArray(list) ? list : (list ? [list] : []);
        }

        // ë§ˆì»¤ ìƒ‰ìƒ ê²°ì •
        function getMarkerColor(specialtyTheaters) {
            const theaters = normalizeSpecialties(specialtyTheaters).join(',');
            if (theaters.includes('ì•„ì´ë§¥ìŠ¤')) return 'red';
            if (theaters.includes('DOLBY')) return 'blue';
            return 'green';
        }

        // SVG ê¸°ë°˜ ë§ˆì»¤ ì´ë¯¸ì§€
        function createMarkerImage(color) {
            const colorMap = {
                red: '#ef4444',
                blue: '#3b82f6',
                green: '#22c55e',
                star: '#fbbf24'
            };
            const fill = colorMap[color] || colorMap.red;

            const svg = color === 'star'
                ? `<svg width="32" height="32" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="${fill}" stroke="#fff" stroke-width="1"/>
                   </svg>`
                : `<svg width="32" height="42" viewBox="0 0 32 42" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 0C7.163 0 0 7.163 0 16c0 11.25 16 26 16 26s16-14.75 16-26C32 7.163 24.837 0 16 0z" fill="${fill}" />
                    <circle cx="16" cy="16" r="7" fill="#fff" />
                   </svg>`;

            const size = color === 'star' ? new kakao.maps.Size(32, 32) : new kakao.maps.Size(32, 42);
            const offset = color === 'star' ? new kakao.maps.Point(16, 16) : new kakao.maps.Point(16, 42);

            const url = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
            return new kakao.maps.MarkerImage(url, size, {offset: offset});
        }

        // ê±°ë¦¬ ê³„ì‚° (Haversine)
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ë‚´ ì£¼ë³€ ê·¹ì¥ ì°¾ê¸°
        window.findNearby = function() {
            if (!navigator.geolocation) {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    const myPosition = new kakao.maps.LatLng(lat, lon);
                    map.setCenter(myPosition);
                    map.setLevel(6);

                    // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
                    if (myLocationMarker) {
                        myLocationMarker.setMap(null);
                    }

                    // ë‚´ ìœ„ì¹˜ ë§ˆì»¤
                    myLocationMarker = new kakao.maps.Marker({
                        position: myPosition,
                        map: map,
                        image: createMarkerImage('star'),
                        title: 'ë‚´ ìœ„ì¹˜'
                    });

                    // ê±°ë¦¬ ê³„ì‚°
                    const nearby = specialCinemas
                        .filter(c => c.latitude && c.longitude)
                        .map(cinema => ({
                            ...cinema,
                            distance: getDistance(lat, lon, cinema.latitude, cinema.longitude)
                        }))
                        .filter(c => c.distance <= 10)
                        .sort((a, b) => a.distance - b.distance)
                        .slice(0, 5);

                    if (nearby.length > 0) {
                        showNearbyList(nearby);
                    } else {
                        alert('10km ì´ë‚´ íŠ¹ë³„ê´€ì´ ì—†ìŠµë‹ˆë‹¤.');
                    }
                },
                function(error) {
                    alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                }
            );
        };

        // ê·¼ì²˜ ê·¹ì¥ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
        function showNearbyList(cinemas) {
            let html = '<div style="background:white; padding:20px; margin-top:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">';
            html += '<h3 style="margin:0 0 15px; font-size:16px;">ğŸ“ ë‚´ ì£¼ë³€ íŠ¹ë³„ê´€ (10km ì´ë‚´)</h3>';

            cinemas.forEach((cinema, index) => {
                const specialties = normalizeSpecialties(cinema.specialtyTheaters);
                html += `
                    <div style="padding:12px; border-bottom:1px solid #eee; cursor:pointer;"
                         onclick="map.setCenter(new kakao.maps.LatLng(${cinema.latitude}, ${cinema.longitude})); map.setLevel(4);">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <strong style="font-size:14px;">${index + 1}. ${cinema.cinemaName}</strong>
                            <span style="color:#e91e63; font-weight:bold;">${cinema.distance.toFixed(1)}km</span>
                        </div>
                        <div style="margin-top:5px;">
                            <span style="color:#666; font-size:12px;">${cinema.brand}</span>
                            <span style="margin-left:10px; color:#999; font-size:12px;">
                                ${specialties.join(', ')}
                            </span>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            document.getElementById('nearby-result').innerHTML = html;
        }

        // ë§ˆì»¤ í‘œì‹œ
        specialCinemas.forEach(cinema => {
            if (cinema.latitude && cinema.longitude) {
                const position = new kakao.maps.LatLng(cinema.latitude, cinema.longitude);
                bounds.extend(position);

                const specialties = normalizeSpecialties(cinema.specialtyTheaters);
                const color = getMarkerColor(specialties);
                const markerImage = createMarkerImage(color);

                const marker = new kakao.maps.Marker({
                    position: position,
                    image: markerImage,
                    map: map,
                    title: cinema.cinemaName
                });

                const infowindow = new kakao.maps.InfoWindow({
                    content: `
                        <div style="padding:15px; min-width:200px; position:relative;">
                            <button onclick="closeInfowindow()"
                                    style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:18px; cursor:pointer; color:#999;">
                                âœ•
                            </button>
                            <h3 style="margin:0 0 8px; font-size:15px; font-weight:bold; padding-right:20px;">
                                ${cinema.cinemaName}
                            </h3>
                            <span style="background:#e91e63; color:white; padding:2px 8px; border-radius:3px; font-size:11px;">
                                ${cinema.brand}
                            </span>
                            <p style="margin:8px 0 0; color:#666; font-size:12px;">
                                ${cinema.streetAddress}
                            </p>
                            <div style="margin-top:8px;">
                                ${specialties.length ? specialties.map(t =>
                                    `<span style="background:#f0f0f0; padding:2px 6px; margin-right:3px; border-radius:3px; font-size:11px;">ğŸ¬ ${t}</span>`
                                ).join('') : '<span style="font-size:11px; color:#999;">íŠ¹ë³„ê´€ ì •ë³´ ì—†ìŒ</span>'}
                            </div>
                        </div>
                    `,
                    removable: true
                });

                kakao.maps.event.addListener(marker, 'click', function() {
                    if (currentInfowindow) {
                        currentInfowindow.close();
                    }
                    infowindow.open(map, marker);
                    currentInfowindow = infowindow;
                });
            }
        });

        window.closeInfowindow = function() {
            if (currentInfowindow) {
                currentInfowindow.close();
                currentInfowindow = null;
            }
        };

        map.setBounds(bounds);

        });

        /*]]>*/
    </script>
</section>